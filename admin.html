<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | JayyBl3nz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a5f', secondary: '#152238', accent: '#dc2626',
                        red: '#b91c1c', cream: '#f8fafc', charcoal: '#374151',
                    },
                    fontFamily: { display: ['Playfair Display', 'serif'], body: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-btn { border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn.active { border-bottom-color: #dc2626; color: #dc2626; }
        .appt-card { transition: box-shadow 0.2s; }
        .appt-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        input[type="time"], input[type="date"] { color-scheme: light; }
    </style>
</head>
<body class="bg-cream font-body min-h-screen">

    <!-- Password Gate -->
    <div id="password-gate" class="fixed inset-0 bg-primary z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-10 max-w-sm w-full mx-4 shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="font-display text-white text-2xl font-bold">JB</span>
                </div>
                <h2 class="font-display text-2xl text-primary">Admin Panel</h2>
                <p class="text-gray-400 text-sm mt-1">JayyBl3nz</p>
            </div>
            <input type="password" id="password-input" placeholder="Password"
                class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 mb-3 focus:outline-none focus:border-accent text-charcoal"
                onkeydown="if(event.key==='Enter') checkPassword()" />
            <p id="password-error" class="text-accent text-sm text-center mb-3 hidden">Incorrect password. Try again.</p>
            <button onclick="checkPassword()" class="w-full bg-accent text-white py-3 rounded-full font-semibold hover:bg-red transition-colors">
                Enter
            </button>
        </div>
    </div>

    <!-- Admin Content -->
    <div id="admin-content" class="hidden min-h-screen">

        <!-- Header -->
        <div class="bg-primary text-white py-4 px-6 flex items-center justify-between sticky top-0 z-40 shadow-lg">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    <span class="font-display text-accent text-lg font-bold">JB</span>
                </div>
                <span class="font-display text-xl">Admin Panel</span>
            </div>
            <div class="flex items-center gap-4">
                <span id="firebase-status" class="text-xs px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-300">Demo Mode</span>
                <button onclick="logout()" class="text-gray-300 hover:text-white text-sm transition-colors">Logout</button>
            </div>
        </div>

        <!-- Tab Bar -->
        <div class="bg-white border-b sticky top-16 z-30">
            <div class="max-w-6xl mx-auto px-4 flex overflow-x-auto">
                <button class="tab-btn active px-5 py-4 text-sm font-medium whitespace-nowrap" data-tab="pending" onclick="switchTab('pending')">
                    Pending
                    <span id="pending-badge" class="ml-2 bg-accent text-white text-xs px-2 py-0.5 rounded-full">0</span>
                </button>
                <button class="tab-btn px-5 py-4 text-sm font-medium whitespace-nowrap text-gray-500 hover:text-primary" data-tab="confirmed" onclick="switchTab('confirmed')">
                    Confirmed
                </button>
                <button class="tab-btn px-5 py-4 text-sm font-medium whitespace-nowrap text-gray-500 hover:text-primary" data-tab="denied" onclick="switchTab('denied')">
                    Denied
                </button>
                <button class="tab-btn px-5 py-4 text-sm font-medium whitespace-nowrap text-gray-500 hover:text-primary" data-tab="schedule" onclick="switchTab('schedule')">
                    Schedule
                </button>
                <button class="tab-btn px-5 py-4 text-sm font-medium whitespace-nowrap text-gray-500 hover:text-primary" data-tab="blocked" onclick="switchTab('blocked')">
                    Block Dates
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="max-w-6xl mx-auto px-4 py-8">

            <!-- Pending -->
            <div id="tab-pending" class="tab-content">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="font-display text-2xl text-primary">Pending Requests</h2>
                    <button onclick="loadAppointments()" class="text-sm text-accent hover:underline">Refresh</button>
                </div>
                <div id="pending-list">
                    <div class="flex items-center justify-center py-16">
                        <div class="w-8 h-8 border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
                    </div>
                </div>
            </div>

            <!-- Confirmed -->
            <div id="tab-confirmed" class="tab-content hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="font-display text-2xl text-primary">Confirmed Appointments</h2>
                    <button onclick="loadAppointments()" class="text-sm text-accent hover:underline">Refresh</button>
                </div>
                <div id="confirmed-list"></div>
            </div>

            <!-- Denied -->
            <div id="tab-denied" class="tab-content hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="font-display text-2xl text-primary">Denied Requests</h2>
                </div>
                <div id="denied-list"></div>
            </div>

            <!-- Schedule -->
            <div id="tab-schedule" class="tab-content hidden">
                <h2 class="font-display text-2xl text-primary mb-6">Weekly Schedule</h2>
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <div id="schedule-editor" class="space-y-4"></div>
                    <div class="mt-6 flex items-center gap-4">
                        <button onclick="saveSchedule()" class="bg-accent text-white px-8 py-3 rounded-full font-medium hover:bg-red transition-colors">
                            Save Schedule
                        </button>
                        <p id="schedule-msg" class="text-sm text-green-600 hidden">✓ Schedule saved!</p>
                    </div>
                </div>
            </div>

            <!-- Block Dates -->
            <div id="tab-blocked" class="tab-content hidden">
                <h2 class="font-display text-2xl text-primary mb-6">Block Dates</h2>
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                    <p class="text-gray-600 text-sm mb-4">Block a specific date to prevent any new bookings on that day (e.g. vacation, personal time).</p>
                    <div class="flex flex-wrap gap-3">
                        <input type="date" id="block-date-input" class="px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none focus:border-accent text-charcoal" />
                        <input type="text" id="block-reason-input" placeholder="Reason (optional)" class="flex-1 min-w-48 px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none focus:border-accent" />
                        <button onclick="addBlockedDate()" class="bg-primary text-white px-6 py-3 rounded-xl font-medium hover:bg-secondary transition-colors">
                            Block Date
                        </button>
                    </div>
                </div>
                <div id="blocked-list" class="space-y-3"></div>
            </div>

        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
    const ADMIN_PASSWORD = 'jaybl3nz';

    const DEFAULT_SCHEDULE = {
        monday:    { closed: true,  open: '09:00', close: '17:00' },
        tuesday:   { closed: true,  open: '09:00', close: '17:00' },
        wednesday: { closed: true,  open: '09:00', close: '17:00' },
        thursday:  { closed: true,  open: '09:00', close: '17:00' },
        friday:    { closed: false, open: '15:00', close: '21:00' },
        saturday:  { closed: false, open: '07:00', close: '23:30' },
        sunday:    { closed: false, open: '16:00', close: '20:00' }
    };

    const DAY_ORDER = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
    const DAY_LABELS = { monday:'Monday', tuesday:'Tuesday', wednesday:'Wednesday', thursday:'Thursday', friday:'Friday', saturday:'Saturday', sunday:'Sunday' };

    let schedule = JSON.parse(JSON.stringify(DEFAULT_SCHEDULE));
    let blockedDates = [];
    let appointments = [];
    let currentTab = 'pending';

    function checkPassword() {
        const val = document.getElementById('password-input').value;
        if (val === ADMIN_PASSWORD) {
            document.getElementById('password-gate').classList.add('hidden');
            document.getElementById('admin-content').classList.remove('hidden');
            init();
        } else {
            document.getElementById('password-error').classList.remove('hidden');
            document.getElementById('password-input').value = '';
        }
    }

    function logout() {
        document.getElementById('password-gate').classList.remove('hidden');
        document.getElementById('admin-content').classList.add('hidden');
        document.getElementById('password-input').value = '';
        document.getElementById('password-error').classList.add('hidden');
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tab).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active', 'text-accent');
            btn.classList.add('text-gray-500');
        });
        const activeBtn = document.querySelector(`[data-tab="${tab}"]`);
        if (activeBtn) { activeBtn.classList.add('active', 'text-accent'); activeBtn.classList.remove('text-gray-500'); }
    }

    async function init() {
        if (window.JBFirebaseReady) {
            document.getElementById('firebase-status').textContent = 'Live';
            document.getElementById('firebase-status').className = 'text-xs px-3 py-1 rounded-full bg-green-500/20 text-green-300';
        }
        await Promise.all([loadScheduleConfig(), loadBlockedDates(), loadAppointments()]);
        renderScheduleEditor();
        renderBlockedList();
    }

    async function loadScheduleConfig() {
        if (window.db) {
            try {
                const doc = await window.db.collection('config').doc('schedule').get();
                if (doc.exists) schedule = doc.data();
            } catch (e) {}
        } else {
            const saved = localStorage.getItem('jb_schedule');
            if (saved) schedule = JSON.parse(saved);
        }
    }

    async function loadBlockedDates() {
        if (window.db) {
            try {
                const doc = await window.db.collection('config').doc('blocked').get();
                if (doc.exists) blockedDates = doc.data().dates || [];
            } catch (e) {}
        } else {
            blockedDates = JSON.parse(localStorage.getItem('jb_blocked') || '[]');
        }
    }

    async function loadAppointments() {
        if (window.db) {
            try {
                const snapshot = await window.db.collection('appointments').get();
                appointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort client-side newest first
                appointments.sort((a, b) => {
                    const ta = a.createdAt?.toDate?.() || new Date(a.createdAt || 0);
                    const tb = b.createdAt?.toDate?.() || new Date(b.createdAt || 0);
                    return tb - ta;
                });
            } catch (e) {
                console.error('Failed to load appointments:', e);
                appointments = [];
            }
        } else {
            appointments = JSON.parse(localStorage.getItem('jb_appointments') || '[]');
        }
        renderAppointments();
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr + 'T00:00:00');
        return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatTime(timeStr) {
        if (!timeStr) return '';
        const [h, m] = timeStr.split(':').map(Number);
        const ampm = h >= 12 ? 'PM' : 'AM';
        const h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
        return `${h12}:${m.toString().padStart(2,'0')} ${ampm}`;
    }

    function formatCreatedAt(ts) {
        if (!ts) return '';
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' at ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }

    function appointmentCard(appt, showActions) {
        const statusColors = {
            pending:   'bg-yellow-100 text-yellow-700',
            confirmed: 'bg-green-100 text-green-700',
            denied:    'bg-red-100 text-red-500'
        };
        const badge = `<span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColors[appt.status] || 'bg-gray-100 text-gray-600'}">${appt.status.charAt(0).toUpperCase() + appt.status.slice(1)}</span>`;
        const actions = showActions ? `
            <div class="flex gap-2 mt-4">
                <button onclick="updateStatus('${appt.id}', 'confirmed')" class="flex-1 bg-green-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">✓ Confirm</button>
                <button onclick="updateStatus('${appt.id}', 'denied')" class="flex-1 bg-accent text-white py-2 rounded-lg text-sm font-medium hover:bg-red transition-colors">✕ Deny</button>
            </div>` : '';
        const instagram = appt.instagram ? `<a href="https://instagram.com/${appt.instagram}" target="_blank" class="text-accent hover:underline">@${appt.instagram}</a>` : '<span class="text-gray-400">—</span>';

        return `
        <div class="appt-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h3 class="font-semibold text-primary text-lg">${appt.name}</h3>
                    <p class="text-gray-500 text-xs mt-0.5">Submitted ${formatCreatedAt(appt.createdAt)}</p>
                </div>
                ${badge}
            </div>
            <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                <div><span class="text-gray-400">Service</span><br><span class="font-medium text-charcoal">${appt.service}</span></div>
                <div><span class="text-gray-400">Price</span><br><span class="font-medium text-accent">$${appt.price}</span></div>
                <div><span class="text-gray-400">Date</span><br><span class="font-medium text-charcoal">${formatDate(appt.date)}</span></div>
                <div><span class="text-gray-400">Time</span><br><span class="font-medium text-charcoal">${formatTime(appt.timeSlot)}</span></div>
                <div><span class="text-gray-400">Phone</span><br><a href="tel:${appt.phone}" class="font-medium text-primary hover:underline">${appt.phone}</a></div>
                <div><span class="text-gray-400">Instagram</span><br>${instagram}</div>
            </div>
            ${actions}
        </div>`;
    }

    function emptyState(msg) {
        return `<div class="text-center py-16 text-gray-400">
            <svg class="w-12 h-12 mx-auto mb-3 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <p class="font-medium">${msg}</p>
        </div>`;
    }

    function renderAppointments() {
        const pending   = appointments.filter(a => a.status === 'pending');
        const confirmed = appointments.filter(a => a.status === 'confirmed');
        const denied    = appointments.filter(a => a.status === 'denied');

        document.getElementById('pending-badge').textContent = pending.length;

        document.getElementById('pending-list').innerHTML = pending.length
            ? `<div class="grid md:grid-cols-2 gap-4">${pending.map(a => appointmentCard(a, true)).join('')}</div>`
            : emptyState('No pending requests');

        document.getElementById('confirmed-list').innerHTML = confirmed.length
            ? `<div class="grid md:grid-cols-2 gap-4">${confirmed.map(a => appointmentCard(a, false)).join('')}</div>`
            : emptyState('No confirmed appointments');

        document.getElementById('denied-list').innerHTML = denied.length
            ? `<div class="grid md:grid-cols-2 gap-4">${denied.map(a => appointmentCard(a, false)).join('')}</div>`
            : emptyState('No denied requests');
    }

    async function updateStatus(id, status) {
        if (window.db) {
            try {
                await window.db.collection('appointments').doc(id).update({ status });
            } catch (e) { alert('Error updating. Check Firebase connection.'); return; }
        } else {
            const idx = appointments.findIndex(a => a.id === id);
            if (idx >= 0) appointments[idx].status = status;
            localStorage.setItem('jb_appointments', JSON.stringify(appointments));
        }
        const idx = appointments.findIndex(a => a.id === id);
        if (idx >= 0) appointments[idx].status = status;
        renderAppointments();
    }

    function renderScheduleEditor() {
        const el = document.getElementById('schedule-editor');
        el.innerHTML = DAY_ORDER.map(day => {
            const cfg = schedule[day] || DEFAULT_SCHEDULE[day];
            return `
            <div class="flex flex-wrap items-center gap-4 py-4 border-b border-gray-100 last:border-0">
                <div class="w-28 font-medium text-charcoal">${DAY_LABELS[day]}</div>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="closed-${day}" ${cfg.closed ? 'checked' : ''}
                        onchange="toggleDay('${day}')" class="w-4 h-4 accent-accent" />
                    <span class="text-sm text-gray-600">Closed</span>
                </label>
                <div id="hours-${day}" class="flex items-center gap-2 ${cfg.closed ? 'opacity-30 pointer-events-none' : ''}">
                    <input type="time" id="open-${day}" value="${cfg.open || '09:00'}"
                        class="px-3 py-2 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-accent text-sm text-charcoal" />
                    <span class="text-gray-400 text-sm">to</span>
                    <input type="time" id="close-${day}" value="${cfg.close || '17:00'}"
                        class="px-3 py-2 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-accent text-sm text-charcoal" />
                </div>
                ${day === 'sunday' ? '<span class="text-xs bg-accent text-white px-2 py-0.5 rounded-full font-semibold">Rush Day $25</span>' : ''}
            </div>`;
        }).join('');
    }

    function toggleDay(day) {
        const closed = document.getElementById('closed-' + day).checked;
        const hoursEl = document.getElementById('hours-' + day);
        hoursEl.classList.toggle('opacity-30', closed);
        hoursEl.classList.toggle('pointer-events-none', closed);
    }

    async function saveSchedule() {
        const newSchedule = {};
        DAY_ORDER.forEach(day => {
            newSchedule[day] = {
                closed: document.getElementById('closed-' + day).checked,
                open:   document.getElementById('open-' + day).value,
                close:  document.getElementById('close-' + day).value
            };
        });
        schedule = newSchedule;

        if (window.db) {
            try { await window.db.collection('config').doc('schedule').set(schedule); } catch (e) {}
        }
        localStorage.setItem('jb_schedule', JSON.stringify(schedule));

        const msg = document.getElementById('schedule-msg');
        msg.classList.remove('hidden');
        setTimeout(() => msg.classList.add('hidden'), 3000);
    }

    async function addBlockedDate() {
        const dateInput   = document.getElementById('block-date-input');
        const reasonInput = document.getElementById('block-reason-input');
        const dateVal     = dateInput.value;
        if (!dateVal) { alert('Please select a date to block.'); return; }
        if (blockedDates.find(b => b.date === dateVal)) { alert('This date is already blocked.'); return; }

        blockedDates.push({ date: dateVal, reason: reasonInput.value.trim() });
        dateInput.value   = '';
        reasonInput.value = '';
        await saveBlockedDates();
        renderBlockedList();
    }

    async function removeBlockedDate(date) {
        blockedDates = blockedDates.filter(b => b.date !== date);
        await saveBlockedDates();
        renderBlockedList();
    }

    async function saveBlockedDates() {
        if (window.db) {
            try { await window.db.collection('config').doc('blocked').set({ dates: blockedDates.map(b => b.date) }); } catch (e) {}
        }
        localStorage.setItem('jb_blocked', JSON.stringify(blockedDates));
    }

    function renderBlockedList() {
        const el = document.getElementById('blocked-list');
        if (!blockedDates.length) {
            el.innerHTML = '<p class="text-gray-400 text-sm">No dates blocked.</p>';
            return;
        }
        el.innerHTML = blockedDates.map(b => {
            const d = new Date(b.date + 'T00:00:00');
            const label = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            return `
            <div class="bg-white rounded-xl px-5 py-4 flex items-center justify-between shadow-sm border border-gray-100">
                <div>
                    <p class="font-medium text-charcoal">${label}</p>
                    ${b.reason ? `<p class="text-sm text-gray-400 mt-0.5">${b.reason}</p>` : ''}
                </div>
                <button onclick="removeBlockedDate('${b.date}')" class="text-red-400 hover:text-red-600 transition-colors ml-4">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>`;
        }).join('');
    }
    </script>
</body>
</html>
